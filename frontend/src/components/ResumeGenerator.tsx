import { useState } from 'react'

interface FormData {
  name: string
  title: string
  email: string
  phone: string
  location: string
  experience: string
  education: string
  skills: string
  summary: string
}

const templates = [
  { id: 'modern', name: 'ç°ä»£ç®€çº¦', color: 'blue' },
  { id: 'professional', name: 'ä¸“ä¸šç»å…¸', color: 'gray' },
  { id: 'creative', name: 'åˆ›æ„è®¾è®¡', color: 'purple' },
  { id: 'tech', name: 'ç§‘æŠ€æå®¢', color: 'green' },
]

function ResumeGenerator() {
  const [formData, setFormData] = useState<FormData>({
    name: '',
    title: '',
    email: '',
    phone: '',
    location: '',
    experience: '',
    education: '',
    skills: '',
    summary: '',
  })
  const [selectedTemplate, setSelectedTemplate] = useState('modern')
  const [generatedResume, setGeneratedResume] = useState('')
  const [loading, setLoading] = useState(false)
  const [isEditing, setIsEditing] = useState(false)
  const [editedResume, setEditedResume] = useState('')
  const [showSuccess, setShowSuccess] = useState(false)

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value })
  }

  const handleGenerate = () => {
    if (!formData.name || !formData.experience) {
      alert('è¯·å¡«å†™å§“åå’Œå·¥ä½œç»éªŒ')
      return
    }

    setLoading(true)

    // æ¨¡æ‹Ÿ AI ç”Ÿæˆç®€å†
    setTimeout(() => {
      const resume = generateResumeFromTemplate(formData, selectedTemplate)
      setGeneratedResume(resume)
      setEditedResume(resume)
      setLoading(false)
      setShowSuccess(true)
      setTimeout(() => setShowSuccess(false), 3000)
    }, 2000)
  }

  const generateResumeFromTemplate = (data: FormData, template: string) => {
    const skills = data.skills.split(',').map(s => s.trim()).filter(s => s)

    if (template === 'modern') {
      return `
# ${data.name}
**${data.title || 'é«˜çº§å·¥ç¨‹å¸ˆ'}**

ğŸ“§ ${data.email} | ğŸ“± ${data.phone} | ğŸ“ ${data.location}

---

## ğŸ’¡ ä¸ªäººç®€ä»‹

${data.summary || 'å¯Œæœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆï¼Œä¸“æ³¨äºæŠ€æœ¯åˆ›æ–°å’Œå›¢é˜Ÿåä½œã€‚'}

---

## ğŸ› ï¸ æ ¸å¿ƒæŠ€èƒ½

${skills.map(skill => `- **${skill}**`).join('\n')}

---

## ğŸ’¼ å·¥ä½œç»éªŒ

${data.experience}

---

## ğŸ“ æ•™è‚²èƒŒæ™¯

${data.education}

---

*ç®€å†ç”± Gitvim AI ç”Ÿæˆ*
      `.trim()
    } else if (template === 'professional') {
      return `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
              ${data.name}
          ${data.title || 'é«˜çº§å·¥ç¨‹å¸ˆ'}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è”ç³»æ–¹å¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é‚®ç®±ï¼š${data.email}
ç”µè¯ï¼š${data.phone}
åœ°ç‚¹ï¼š${data.location}

èŒä¸šæ¦‚è¿°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${data.summary || 'å¯Œæœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆï¼Œä¸“æ³¨äºæŠ€æœ¯åˆ›æ–°å’Œå›¢é˜Ÿåä½œã€‚'}

ä¸“ä¸šæŠ€èƒ½
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${skills.join(' | ')}

å·¥ä½œç»å†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${data.experience}

æ•™è‚²èƒŒæ™¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${data.education}
      `.trim()
    } else if (template === 'creative') {
      return `
âœ¦ ${data.name} âœ¦
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ${data.title || 'åˆ›æ„å·¥ç¨‹å¸ˆ'}

ğŸ’Œ ${data.email}
ğŸ“± ${data.phone}
ğŸŒ ${data.location}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ å…³äºæˆ‘
${data.summary || 'å¯Œæœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆï¼Œä¸“æ³¨äºæŠ€æœ¯åˆ›æ–°å’Œå›¢é˜Ÿåä½œã€‚'}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¨ æŠ€èƒ½æ ‘
${skills.map(skill => `â–¸ ${skill}`).join('\n')}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¼ ç»å†
${data.experience}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ æ•™è‚²
${data.education}
      `.trim()
    } else {
      // Tech template
      return `
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ${data.name.padEnd(30)}â”‚
â”‚  ${data.title.padEnd(30)}â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

> CONTACT
  Email: ${data.email}
  Phone: ${data.phone}
  Location: ${data.location}

> ABOUT
  ${data.summary || 'å¯Œæœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆï¼Œä¸“æ³¨äºæŠ€æœ¯åˆ›æ–°å’Œå›¢é˜Ÿåä½œã€‚'}

> SKILLS
${skills.map(skill => `  [${skill}]`).join(' ')}

> EXPERIENCE
  ${data.experience.replace(/\n/g, '\n  ')}

> EDUCATION
  ${data.education}

---
Generated by Gitvim AI
      `.trim()
    }
  }

  const handleExport = (format: 'pdf' | 'word') => {
    if (format === 'pdf') {
      exportToPDF()
    } else {
      exportToWord()
    }
  }

  const exportToPDF = async () => {
    // åŠ¨æ€å¯¼å…¥ html2pdf.js
    const html2pdf = (await import('html2pdf.js')).default
    
    // åˆ›å»ºä¸´æ—¶å®¹å™¨
    const element = document.createElement('div')
    element.innerHTML = generatedResume.replace(/\n/g, '<br>')
    element.style.padding = '40px'
    element.style.fontFamily = 'Arial, sans-serif'
    element.style.fontSize = '14px'
    element.style.lineHeight = '1.6'
    
    const opt = {
      margin: 10,
      filename: `${formData.name}-ç®€å†.pdf`,
      image: { type: 'jpeg' as const, quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm' as const, format: 'a4' as const, orientation: 'portrait' as const }
    }
    
    html2pdf().set(opt).from(element).save()
  }

  const exportToWord = async () => {
    // åŠ¨æ€å¯¼å…¥ docx åº“
    const { Document, Packer, Paragraph, TextRun, HeadingLevel } = await import('docx')
    const { saveAs } = await import('file-saver')
    
    const doc = new Document({
      sections: [{
        properties: {},
        children: [
          new Paragraph({
            text: formData.name,
            heading: HeadingLevel.TITLE,
          }),
          new Paragraph({
            text: formData.title,
            heading: HeadingLevel.HEADING_1,
          }),
          new Paragraph({
            children: [
              new TextRun({
                text: `ğŸ“§ ${formData.email} | ğŸ“± ${formData.phone} | ğŸ“ ${formData.location}`,
                size: 20,
              }),
            ],
          }),
          new Paragraph({
            text: "ä¸ªäººç®€ä»‹",
            heading: HeadingLevel.HEADING_2,
          }),
          new Paragraph({
            text: formData.summary || 'å¯Œæœ‰ç»éªŒçš„å·¥ç¨‹å¸ˆï¼Œä¸“æ³¨äºæŠ€æœ¯åˆ›æ–°å’Œå›¢é˜Ÿåä½œã€‚',
          }),
          new Paragraph({
            text: "æ ¸å¿ƒæŠ€èƒ½",
            heading: HeadingLevel.HEADING_2,
          }),
          ...formData.skills.split(',').map(skill => 
            new Paragraph({
              text: skill.trim(),
              bullet: { level: 0 }
            })
          ),
          new Paragraph({
            text: "å·¥ä½œç»éªŒ",
            heading: HeadingLevel.HEADING_2,
          }),
          new Paragraph({
            text: formData.experience,
          }),
          new Paragraph({
            text: "æ•™è‚²èƒŒæ™¯",
            heading: HeadingLevel.HEADING_2,
          }),
          new Paragraph({
            text: formData.education,
          }),
        ],
      }],
    })
    
    Packer.toBlob(doc).then(blob => {
      saveAs(blob, `${formData.name}-ç®€å†.docx`)
    })
  }

  return (
    <div className="space-y-6">
      {/* æˆåŠŸæç¤º */}
      {showSuccess && (
        <div className="bg-gradient-to-r from-green-400 to-emerald-500 text-white px-6 py-4 rounded-xl shadow-lg animate-fade-in flex items-center gap-3">
          <span className="text-2xl">âœ…</span>
          <span className="font-medium">ç®€å†ç”ŸæˆæˆåŠŸï¼</span>
        </div>
      )}

      {/* æ¨¡æ¿é€‰æ‹© */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-3">
          é€‰æ‹©ç®€å†æ¨¡æ¿
        </label>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          {templates.map((template) => (
            <button
              key={template.id}
              onClick={() => setSelectedTemplate(template.id)}
              className={`p-6 rounded-2xl border-2 transition-all duration-300 transform hover:scale-105 hover:shadow-xl ${
                selectedTemplate === template.id
                  ? 'border-blue-500 bg-gradient-to-br from-blue-50 to-purple-50 shadow-lg scale-105'
                  : 'border-gray-200 hover:border-gray-300 bg-white/50'
              }`}
            >
              <div className={`text-4xl mb-3 ${
                selectedTemplate === template.id ? 'animate-bounce-soft' : ''
              }`}>
                {template.id === 'modern' && 'ğŸ“„'}
                {template.id === 'professional' && 'ğŸ“‹'}
                {template.id === 'creative' && 'ğŸ¨'}
                {template.id === 'tech' && 'ğŸ’»'}
              </div>
              <div className={`font-semibold ${
                selectedTemplate === template.id 
                  ? 'bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent'
                  : 'text-gray-700'
              }`}>
                {template.name}
              </div>
            </button>
          ))}
        </div>
      </div>

      {/* åŸºæœ¬ä¿¡æ¯ */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            å§“å *
          </label>
          <input
            type="text"
            name="name"
            value={formData.name}
            onChange={handleChange}
            className="input-field"
            placeholder="å¼ ä¸‰"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            èŒä½å¤´è¡”
          </label>
          <input
            type="text"
            name="title"
            value={formData.title}
            onChange={handleChange}
            className="input-field"
            placeholder="é«˜çº§ Python å·¥ç¨‹å¸ˆ"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            é‚®ç®±
          </label>
          <input
            type="email"
            name="email"
            value={formData.email}
            onChange={handleChange}
            className="input-field"
            placeholder="zhangsan@example.com"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            ç”µè¯
          </label>
          <input
            type="tel"
            name="phone"
            value={formData.phone}
            onChange={handleChange}
            className="input-field"
            placeholder="138-0000-0000"
          />
        </div>
        <div className="md:col-span-2">
          <label className="block text-sm font-medium text-gray-700 mb-2">
            æ‰€åœ¨åŸå¸‚
          </label>
          <input
            type="text"
            name="location"
            value={formData.location}
            onChange={handleChange}
            className="input-field"
            placeholder="åŒ—äº¬"
          />
        </div>
      </div>

      {/* æŠ€èƒ½ */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          æ ¸å¿ƒæŠ€èƒ½ï¼ˆé€—å·åˆ†éš”ï¼‰
        </label>
        <input
          type="text"
          name="skills"
          value={formData.skills}
          onChange={handleChange}
          className="input-field"
          placeholder="Python, Django, PostgreSQL, Docker, å›¢é˜Ÿç®¡ç†"
        />
      </div>

      {/* ä¸ªäººç®€ä»‹ */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          ä¸ªäººç®€ä»‹
        </label>
        <textarea
          name="summary"
          value={formData.summary}
          onChange={handleChange}
          className="input-field h-24 resize-none"
          placeholder="5å¹´Pythonå¼€å‘ç»éªŒï¼Œä¸“æ³¨äºåç«¯æ¶æ„è®¾è®¡å’Œæ€§èƒ½ä¼˜åŒ–..."
        />
      </div>

      {/* å·¥ä½œç»éªŒ */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          å·¥ä½œç»éªŒ *
        </label>
        <textarea
          name="experience"
          value={formData.experience}
          onChange={handleChange}
          className="input-field h-40 resize-none"
          placeholder={`é«˜çº§å·¥ç¨‹å¸ˆ | ABC å…¬å¸ | 2020-è‡³ä»Š
- è´Ÿè´£æ ¸å¿ƒç³»ç»Ÿæ¶æ„è®¾è®¡ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½ 40%
- å¸¦é¢† 5 äººå›¢é˜Ÿå®Œæˆå¾®æœåŠ¡æ”¹é€ 
- ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢ï¼Œå“åº”æ—¶é—´é™ä½ 60%

å·¥ç¨‹å¸ˆ | XYZ å…¬å¸ | 2018-2020
- å¼€å‘è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶ï¼Œè¦†ç›–ç‡ä» 30% æå‡åˆ° 85%
- ...`}
        />
      </div>

      {/* æ•™è‚²èƒŒæ™¯ */}
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">
          æ•™è‚²èƒŒæ™¯
        </label>
        <textarea
          name="education"
          value={formData.education}
          onChange={handleChange}
          className="input-field h-24 resize-none"
          placeholder="è®¡ç®—æœºç§‘å­¦å­¦å£« | åŒ—äº¬å¤§å­¦ | 2014-2018"
        />
      </div>

      {/* ç”ŸæˆæŒ‰é’® */}
      <div className="flex gap-4">
        <button
          onClick={handleGenerate}
          disabled={loading}
          className="btn-primary flex-1 text-lg py-4 relative overflow-hidden group"
        >
          {loading ? (
            <span className="flex items-center justify-center gap-3">
              <span className="inline-block w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
              ç”Ÿæˆä¸­...
            </span>
          ) : (
            <span className="relative z-10">
              âœ¨ ç”Ÿæˆç®€å†
            </span>
          )}
          {!loading && (
            <div className="absolute inset-0 bg-gradient-to-r from-purple-600 to-pink-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          )}
        </button>
      </div>

      {/* ç”Ÿæˆçš„ç®€å†é¢„è§ˆ */}
      {generatedResume && (
        <div className="space-y-4 animate-fade-in">
          <div className="flex items-center justify-between">
            <h3 className="font-semibold text-gray-900 text-xl">
              {isEditing ? 'âœï¸ ç¼–è¾‘ç®€å†' : 'ğŸ“„ ç”Ÿæˆçš„ç®€å†é¢„è§ˆ'}
            </h3>
            <div className="flex gap-2 flex-wrap">
              {!isEditing ? (
                <>
                  <button
                    onClick={() => setIsEditing(true)}
                    className="px-4 py-2 text-sm bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white rounded-lg transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105"
                  >
                    âœï¸ ç¼–è¾‘
                  </button>
                  <button
                    onClick={() => {
                      navigator.clipboard.writeText(generatedResume)
                      alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')
                    }}
                    className="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-300"
                  >
                    ğŸ“‹ å¤åˆ¶
                  </button>
                  <button
                    onClick={() => handleExport('pdf')}
                    className="px-4 py-2 text-sm bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-lg transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105"
                  >
                    ğŸ“„ å¯¼å‡º PDF
                  </button>
                  <button
                    onClick={() => handleExport('word')}
                    className="px-4 py-2 text-sm bg-gradient-to-r from-blue-500 to-indigo-500 hover:from-blue-600 hover:to-indigo-600 text-white rounded-lg transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105"
                  >
                    ğŸ“ å¯¼å‡º Word
                  </button>
                </>
              ) : (
                <>
                  <button
                    onClick={() => {
                      setGeneratedResume(editedResume)
                      setIsEditing(false)
                    }}
                    className="px-4 py-2 text-sm bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white rounded-lg transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105"
                  >
                    âœ… ä¿å­˜
                  </button>
                  <button
                    onClick={() => {
                      setEditedResume(generatedResume)
                      setIsEditing(false)
                    }}
                    className="px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-all duration-300"
                  >
                    âŒ å–æ¶ˆ
                  </button>
                </>
              )}
            </div>
          </div>
          {isEditing ? (
            <textarea
              value={editedResume}
              onChange={(e) => setEditedResume(e.target.value)}
              className="w-full h-[600px] bg-white/80 backdrop-blur-sm rounded-2xl p-6 font-mono text-sm border-2 border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 resize-y shadow-lg"
              placeholder="ç¼–è¾‘ä½ çš„ç®€å†..."
            />
          ) : (
            <div className="bg-gradient-to-br from-gray-50 to-blue-50 rounded-2xl p-8 whitespace-pre-wrap font-mono text-sm max-h-[600px] overflow-y-auto border-2 border-gray-200 shadow-lg">
              {generatedResume}
            </div>
          )}
        </div>
      )}
    </div>
  )
}

export default ResumeGenerator
